<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>流星魔法</title>
<style>
html,body{height:100%;margin:0;overflow:hidden;background:#0b0b10;}
#gameCanvas{display:block;}
#hint{
    position: fixed;
    top: 12px; left: 12px;
    color: #fff;
    font-family: sans-serif;
    background: rgba(0,0,0,0.7);
    padding: 8px 12px;
    border-radius: 6px;
    z-index:10;
    font-size: 1.2em;
}
#dialogOverlay{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.85);
    z-index:9999;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    font-family:sans-serif;
    font-size:2.5em;
    color:#fff;
    white-space: pre-wrap;
}
</style>
</head>
<body>

<div id="hint">點擊任意一處發射魔法</div>
<canvas id="gameCanvas"></canvas>
<div id="dialogOverlay"></div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
function resize(){canvas.width=innerWidth;canvas.height=innerHeight;}
addEventListener('resize',resize);resize();

/* ---------------- 圖片 ---------------- */
const characterIdle = new Image();
const characterCast = new Image();
characterIdle.src = 'character_idle.png';
characterCast.src = 'character_cast.png';

let characterLoaded=false;
characterIdle.onload = characterCast.onload = ()=>characterLoaded=true;

/* ---------------- 狀態 ---------------- */
let introPlaying = true;
let isCasting = false;
let castEndTime = 0;

const character = {
    x: innerWidth/2,
    y: innerHeight/2,
    size: 32,
    vx:(Math.random()-0.5)*3,
    vy:(Math.random()-0.5)*3
};

let projectiles=[];
let particles=[];

function now(){return performance.now()/1000;}
function lerp(a,b,t){return a+(b-a)*t;}

/* ---------------- 開場對話 ---------------- */
function showIntroDialog(){
    const o=document.getElementById('dialogOverlay');
    o.style.display='flex';
    o.style.opacity=1;
    o.innerHTML='哇哈哈!新的世界?\n我要在這裡盡情破壞!!!';

    setTimeout(()=>{
        o.style.transition='opacity 1s';
        o.style.opacity=0;
        setTimeout(()=>{
            o.style.display='none';
            introPlaying=false;
        },1000);
    },3000);
}

/* ---------------- 移動 ---------------- */
function moveCharacter(){
    if(introPlaying) return;

    character.x+=character.vx;
    character.y+=character.vy;

    if(character.x<character.size||character.x>canvas.width-character.size) character.vx*=-1;
    if(character.y<character.size||character.y>canvas.height-character.size) character.vy*=-1;
}

/* ---------------- 點擊施法 ---------------- */
canvas.addEventListener('click',e=>{
    if(introPlaying) return;

    const r=canvas.getBoundingClientRect();
    const tx=e.clientX-r.left;
    const ty=e.clientY-r.top;

    projectiles.push({
        sx:character.x, sy:character.y,
        tx, ty,
        t0:now(), t1:now()+1
    });

    isCasting=true;
    castEndTime=now()+0.5;
});

/* ---------------- 繪製 ---------------- */
function drawCharacter(){
    if(characterLoaded){
        const img=isCasting?characterCast:characterIdle;
        ctx.drawImage(img,
            character.x-character.size,
            character.y-character.size,
            character.size*2,
            character.size*2
        );
    }else{
        ctx.fillStyle='#5fd0ff';
        ctx.beginPath();
        ctx.arc(character.x,character.y,character.size,0,Math.PI*2);
        ctx.fill();
    }
}

function drawProjectiles(t){
    for(let i=projectiles.length-1;i>=0;i--){
        const p=projectiles[i];
        const k=Math.min(1,(t-p.t0)/(p.t1-p.t0));
        const x=lerp(p.sx,p.tx,k);
        const y=lerp(p.sy,p.ty,k);

        ctx.fillStyle='orange';
        ctx.beginPath();
        ctx.arc(x,y,10,0,Math.PI*2);
        ctx.fill();

        if(k>=1) projectiles.splice(i,1);
    }
}

/* ---------------- 主迴圈 ---------------- */
let last=now();
function loop(){
    const t=now();
    if(isCasting && t>castEndTime) isCasting=false;

    ctx.clearRect(0,0,canvas.width,canvas.height);
    moveCharacter();
    drawCharacter();
    drawProjectiles(t);

    requestAnimationFrame(loop);
}

showIntroDialog();
loop();
</script>
</body>
</html>
